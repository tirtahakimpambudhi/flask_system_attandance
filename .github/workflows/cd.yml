name: Continuous Deploy Workflow

on:
    push:
      branches:
        - master



jobs:
    deploy:
        name: Deploy to VPS
        defaults:
            run:
                shell: bash
        runs-on: ubuntu-latest
        steps:
          - name: 'Checkout repository'
            uses: actions/checkout@v2
          - name: Set up QEMU
            uses: docker/setup-qemu-action@v3
          - name: Set up Docker Buildx
            uses: docker/setup-buildx-action@v3
          - name: 'Login to GitHub Container Registry'
            uses: docker/login-action@v3
            with:
              registry: ghcr.io
              username: ${{github.actor}}
              password: ${{secrets.TOKEN_GITHUB}}

          - name: 'Build Inventory Image'
            run: |
              docker build . --tag ghcr.io/tirtahakimpambudhi/flask_system_attandance:latest
              docker push ghcr.io/tirtahakimpambudhi/flask_system_attandance:latest
            # if error build docker buildx build --progress=plain -t ghcr.io/tirtahakimpambudhi/flask_system_attandance:latest .
          - name: Pull Image in VPS
            uses: appleboy/ssh-action@v1.0.3
            with:
                host: ${{ secrets.HOST }}
                username: ${{ secrets.USERNAME }}
                key: ${{ secrets.KEY }}
                port: ${{ secrets.PORT }}
                script: |
                        # Create necessary directories if they don't exist
                        mkdir -p app/uploads &&
                        mkdir -p app/logs &&
                        # Login GHCR Registry
                        echo '${{secrets.TOKEN_GITHUB}}' | docker login ghcr.io -u tirtahakimpambudhi --password-stdin
                        # Pull the latest image from Docker Hub
                        docker pull ghcr.io/tirtahakimpambudhi/flask_system_attandance:latest 